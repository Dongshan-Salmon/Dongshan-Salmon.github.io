<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>æ‰¹æ¬¡åœ–ç‰‡è™•ç†ï¼ˆå–®æª”ç‰ˆï¼‰</title>
  <style>
    :root { --bg:#0b0f17; --card:#111827; --muted:#9ca3af; --text:#e5e7eb; --line:#243042; --btn:#2563eb; --btn2:#10b981; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;background:linear-gradient(180deg,#070a10, #0b0f17 40%, #070a10);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    h1{font-size:18px;margin:6px 0 10px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:12px;line-height:1.4}
    .grid{display:grid;gap:12px}
    @media(min-width:920px){ .grid{grid-template-columns: 360px 1fr} }
    .card{background:rgba(17,24,39,.92);border:1px solid rgba(36,48,66,.9);border-radius:16px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px}
    input[type="file"], select, input[type="number"], input[type="text"], input[type="range"]{
      width:100%; padding:10px 10px; border-radius:12px; border:1px solid rgba(36,48,66,.9);
      background:#0b1220; color:var(--text); outline:none;
    }
    input[type="range"]{padding:10px}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      appearance:none;border:0;border-radius:12px;padding:10px 12px;font-weight:700;color:white;cursor:pointer;
      background:var(--btn); flex:1; min-width:140px;
    }
    button.secondary{background:#374151}
    button.good{background:var(--btn2)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.45}
    .list{display:grid;gap:10px}
    .item{
      border:1px solid rgba(36,48,66,.85);
      border-radius:16px; padding:10px; background:rgba(11,18,32,.75);
    }
    .itemHead{display:flex; gap:10px; align-items:center}
    .thumb{width:64px;height:64px;border-radius:14px; border:1px solid rgba(36,48,66,.9); object-fit:cover; background:#060912}
    .title{font-size:13px;font-weight:700}
    .meta{font-size:12px;color:var(--muted);margin-top:2px}
    details{margin-top:10px}
    summary{cursor:pointer;color:#cbd5e1;font-weight:700}
    .miniRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .miniRow3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
    .chip{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid rgba(36,48,66,.9);border-radius:999px;background:#0b1220;color:#cbd5e1;font-size:12px}
    .bar{height:8px;background:#0b1220;border:1px solid rgba(36,48,66,.9);border-radius:999px;overflow:hidden}
    .bar > i{display:block;height:100%;width:0;background:#22c55e}
    .out{display:grid;gap:10px;margin-top:10px}
    a.dl{display:inline-block;text-decoration:none;color:white;background:#1f2937;border:1px solid rgba(36,48,66,.9);padding:10px 12px;border-radius:12px;font-weight:700}
    .warn{color:#fbbf24;font-size:12px;line-height:1.45}
    .ok{color:#34d399;font-size:12px}
    .small{font-size:12px;color:var(--muted)}
    .k{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>æ‰¹æ¬¡åœ–ç‰‡è™•ç†ï¼ˆå–®ä¸€ HTMLã€æ‰‹æ©Ÿå¯ç”¨ï¼‰</h1>
    <div class="sub">
      1) é¸ N å¼µåœ–ç‰‡ â†’ 2) è¨­å®šã€Œå…¨åŸŸã€è™•ç† â†’ 3) éœ€è¦çš„è©±å±•é–‹å–®å¼µè¦†å¯« â†’ 4) ä¸€éµè¼¸å‡º N å¼µã€‚<br/>
      âš ï¸ å¤§é‡é«˜è§£æåœ–ç‰‡å¯èƒ½æœƒåƒè¨˜æ†¶é«”ï¼›å»ºè­°ä¸€æ¬¡ 10ï½30 å¼µä¸€æ‰¹ï¼Œæˆ–å…ˆç¸®å°è¼¸å‡ºé•·é‚Šã€‚
    </div>

    <div class="grid">
      <div class="card">
        <label>é¸æ“‡åœ–ç‰‡ï¼ˆå¯å¤šé¸ï¼‰</label>
        <input id="fileInput" type="file" accept="image/*" multiple />

        <div class="k">
          <span class="chip">âœ… æ”¯æ´ï¼šJPG/PNG/WebP/HEIC(è¦–ç€è¦½å™¨)</span>
          <span class="chip">ğŸ“± è¡Œå‹•ç«¯å‹å–„</span>
        </div>

        <hr style="border:0;border-top:1px solid rgba(36,48,66,.8);margin:12px 0" />

        <div class="title" style="margin-bottom:6px">å…¨åŸŸè¨­å®šï¼ˆæ‰¹æ¬¡å¥—ç”¨ï¼‰</div>

        <div class="row">
          <div>
            <label>è¼¸å‡ºæ ¼å¼</label>
            <select id="outFormat">
              <option value="image/jpeg">JPG</option>
              <option value="image/webp">WebP</option>
              <option value="image/png">PNGï¼ˆç„¡å“è³ªåƒæ•¸ï¼‰</option>
            </select>
          </div>
          <div>
            <label>å“è³ª (JPG/WebP)</label>
            <input id="quality" type="range" min="0.4" max="1" step="0.01" value="0.85" />
            <div class="small">ç›®å‰ï¼š<span id="qv">0.85</span></div>
          </div>
        </div>

        <div style="margin-top:10px" class="row">
          <div>
            <label>å°ºå¯¸æ¨¡å¼</label>
            <select id="sizeMode">
              <option value="longEdge">æŒ‡å®šã€Œé•·é‚Šã€</option>
              <option value="wh">æŒ‡å®šã€Œå¯¬ Ã— é«˜ã€</option>
              <option value="scale">å€ç‡ç¸®æ”¾</option>
              <option value="keep">ç¶­æŒåŸå°ºå¯¸</option>
            </select>
          </div>
          <div>
            <label>é•·é‚Š(px) / å€ç‡</label>
            <input id="sizeValue" type="number" value="1600" min="1" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>å¯¬(px)ï¼ˆå°ºå¯¸æ¨¡å¼=å¯¬é«˜æ‰ç”¨ï¼‰</label>
            <input id="wValue" type="number" value="1080" min="1" />
          </div>
          <div>
            <label>é«˜(px)ï¼ˆå°ºå¯¸æ¨¡å¼=å¯¬é«˜æ‰ç”¨ï¼‰</label>
            <input id="hValue" type="number" value="1080" min="1" />
          </div>
        </div>

        <div style="margin-top:10px" class="row">
          <div>
            <label>æ¯”ä¾‹è™•ç†</label>
            <select id="ratioMode">
              <option value="keep">ç¶­æŒåŸæ¯”ä¾‹</option>
              <option value="stretch">å¼·åˆ¶æ‹‰ä¼¸åˆ°ç›®æ¨™å°ºå¯¸</option>
              <option value="crop">è£åˆ‡æˆæŒ‡å®šæ¯”ä¾‹</option>
              <option value="pad">è£œé‚ŠæˆæŒ‡å®šæ¯”ä¾‹</option>
            </select>
          </div>
          <div>
            <label>ç›®æ¨™æ¯”ä¾‹</label>
            <select id="ratioPreset">
              <option value="free">è‡ªç”±ï¼ˆç”¨ä¸‹æ–¹è‡ªè¨‚ï¼‰</option>
              <option value="1:1">1:1</option>
              <option value="4:3">4:3</option>
              <option value="3:4">3:4</option>
              <option value="16:9">16:9</option>
              <option value="9:16">9:16</option>
              <option value="2:3">2:3</option>
              <option value="3:2">3:2</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>è‡ªè¨‚æ¯”ä¾‹å¯¬</label>
            <input id="ratioW" type="number" value="1" min="1" />
          </div>
          <div>
            <label>è‡ªè¨‚æ¯”ä¾‹é«˜</label>
            <input id="ratioH" type="number" value="1" min="1" />
          </div>
        </div>

        <details style="margin-top:10px">
          <summary>å…¨åŸŸã€Œç´°éƒ¨ä¿®æ”¹ã€(æ¿¾é¡/æ—‹è½‰/éŠ³åŒ–)</summary>

          <div class="miniRow">
            <div>
              <label>æ—‹è½‰</label>
              <select id="rot">
                <option value="0">0Â°</option>
                <option value="90">90Â°</option>
                <option value="180">180Â°</option>
                <option value="270">270Â°</option>
              </select>
            </div>
            <div>
              <label>é¡åƒ</label>
              <select id="flip">
                <option value="none">ä¸é¡åƒ</option>
                <option value="h">æ°´å¹³</option>
                <option value="v">å‚ç›´</option>
                <option value="hv">æ°´å¹³+å‚ç›´</option>
              </select>
            </div>
          </div>

          <div class="miniRow" style="margin-top:10px">
            <div>
              <label>äº®åº¦</label>
              <input id="brightness" type="range" min="0.5" max="1.5" step="0.01" value="1" />
            </div>
            <div>
              <label>å°æ¯”</label>
              <input id="contrast" type="range" min="0.5" max="1.5" step="0.01" value="1" />
            </div>
          </div>

          <div class="miniRow" style="margin-top:10px">
            <div>
              <label>é£½å’Œ</label>
              <input id="saturate" type="range" min="0" max="2" step="0.01" value="1" />
            </div>
            <div>
              <label>ç°éš</label>
              <input id="grayscale" type="range" min="0" max="1" step="0.01" value="0" />
            </div>
          </div>

          <div class="miniRow3" style="margin-top:10px">
            <div>
              <label>éŠ³åŒ–ï¼ˆ0~1ï¼‰</label>
              <input id="sharpen" type="range" min="0" max="1" step="0.05" value="0" />
            </div>
            <div>
              <label>æ¨¡ç³Šï¼ˆ0~6pxï¼‰</label>
              <input id="blur" type="range" min="0" max="6" step="0.1" value="0" />
            </div>
            <div>
              <label>è¼¸å‡ºæª”åå‰ç¶´</label>
              <input id="namePrefix" type="text" value="processed_" />
            </div>
          </div>

          <div class="hint">
            æ¿¾é¡ä½¿ç”¨ç€è¦½å™¨ Canvasã€‚éƒ¨åˆ†èˆŠæ‰‹æ©Ÿç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´æŸäº› filterï¼Œä½†é€šå¸¸å¯ç”¨ã€‚
          </div>
        </details>

        <div class="btns">
          <button id="processBtn" class="good" disabled>é–‹å§‹è™•ç† & ç”¢ç”Ÿä¸‹è¼‰</button>
          <button id="clearBtn" class="secondary">æ¸…ç©º</button>
        </div>

        <div style="margin-top:10px">
          <div class="bar"><i id="prog"></i></div>
          <div class="small" style="margin-top:6px">
            ç‹€æ…‹ï¼š<span id="status">å°šæœªé¸æ“‡åœ–ç‰‡</span>
          </div>
          <div id="zipHint" class="warn" style="margin-top:8px;display:none"></div>
        </div>

        <div class="hint">
          ã€Œè£åˆ‡æˆæŒ‡å®šæ¯”ä¾‹ã€= æœƒæŠŠå¤šå‡ºä¾†çš„éƒ¨åˆ†è£æ‰ï¼ˆå¸¸ç”¨æ–¼ IG/è­‰ä»¶/ç‰ˆé¢çµ±ä¸€ï¼‰ã€‚<br/>
          ã€Œè£œé‚ŠæˆæŒ‡å®šæ¯”ä¾‹ã€= ä¸è£å…§å®¹ï¼Œç”¨é»‘é‚Šè£œæ»¿ï¼ˆé©åˆä¸æƒ³è£æ‰ç•«é¢ï¼‰ã€‚
        </div>
      </div>

      <div class="card">
        <div class="title">åœ–ç‰‡æ¸…å–®ï¼ˆæ¯å¼µå¯è¦†å¯«è¨­å®šï¼‰</div>
        <div class="sub" style="margin-top:4px">é»é–‹æ¯å¼µçš„ã€Œå–®å¼µè¦†å¯«ã€å³å¯é‡å°å–®ä¸€ç…§ç‰‡åšä¸åŒè¨­å®šã€‚</div>
        <div id="imgList" class="list"></div>

        <div id="outWrap" class="out" style="display:none">
          <div class="title">è¼¸å‡ºçµæœ</div>
          <div id="outLinks" class="list"></div>
          <div class="btns">
            <button id="zipBtn" disabled>æ‰“åŒ… ZIP ä¸‹è¼‰</button>
            <button id="dlAllBtn" class="secondary" disabled>é€å¼µè§¸ç™¼ä¸‹è¼‰</button>
          </div>
          <div class="hint">
            iOS Safari æœ‰æ™‚æœƒé˜»æ“‹ã€Œé€£çºŒè‡ªå‹•ä¸‹è¼‰ã€ï¼Œå¯æ”¹ç”¨ ZIP æˆ–æ‰‹å‹•é»æ¯å¼µé€£çµä¸‹è¼‰ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JSZip (for ZIP download). If offline, tool still works without ZIP. -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    const el = (id) => document.getElementById(id);

    const fileInput = el('fileInput');
    const imgList = el('imgList');
    const processBtn = el('processBtn');
    const clearBtn = el('clearBtn');
    const statusEl = el('status');
    const progEl = el('prog');
    const outWrap = el('outWrap');
    const outLinks = el('outLinks');
    const zipBtn = el('zipBtn');
    const dlAllBtn = el('dlAllBtn');
    const zipHint = el('zipHint');

    const outFormat = el('outFormat');
    const quality = el('quality');
    const qv = el('qv');

    const sizeMode = el('sizeMode');
    const sizeValue = el('sizeValue');
    const wValue = el('wValue');
    const hValue = el('hValue');

    const ratioMode = el('ratioMode');
    const ratioPreset = el('ratioPreset');
    const ratioW = el('ratioW');
    const ratioH = el('ratioH');

    const rot = el('rot');
    const flip = el('flip');
    const brightness = el('brightness');
    const contrast = el('contrast');
    const saturate = el('saturate');
    const grayscale = el('grayscale');
    const sharpen = el('sharpen');
    const blur = el('blur');
    const namePrefix = el('namePrefix');

    qv.textContent = quality.value;
    quality.addEventListener('input', () => qv.textContent = quality.value);

    ratioPreset.addEventListener('change', () => {
      const v = ratioPreset.value;
      if (v === 'free') return;
      const [a,b] = v.split(':').map(Number);
      ratioW.value = a; ratioH.value = b;
    });

    /** In-memory items: { id, file, url, img, w, h, overrides } */
    let items = [];
    let outputs = []; // {name, blob, url, mime}

    clearBtn.addEventListener('click', () => {
      for (const it of items) URL.revokeObjectURL(it.url);
      for (const o of outputs) URL.revokeObjectURL(o.url);
      items = []; outputs = [];
      imgList.innerHTML = '';
      outLinks.innerHTML = '';
      outWrap.style.display = 'none';
      processBtn.disabled = true;
      zipBtn.disabled = true;
      dlAllBtn.disabled = true;
      progEl.style.width = '0%';
      statusEl.textContent = 'å°šæœªé¸æ“‡åœ–ç‰‡';
      zipHint.style.display = 'none';
    });

    fileInput.addEventListener('change', async () => {
      // reset old
      clearBtn.click();

      const files = Array.from(fileInput.files || []);
      if (!files.length) return;

      statusEl.textContent = 'è®€å–åœ–ç‰‡ä¸­â€¦';
      processBtn.disabled = true;

      items = [];
      for (let i=0;i<files.length;i++){
        const f = files[i];
        const url = URL.createObjectURL(f);
        const img = await loadImage(url);
        items.push({
          id: crypto.randomUUID(),
          file: f,
          url,
          img,
          w: img.naturalWidth || img.width,
          h: img.naturalHeight || img.height,
          overrides: defaultOverrides()
        });
      }

      renderList();
      statusEl.textContent = `å·²è¼‰å…¥ ${items.length} å¼µåœ–ç‰‡`;
      processBtn.disabled = false;
    });

    processBtn.addEventListener('click', async () => {
      if (!items.length) return;

      // cleanup previous outputs
      for (const o of outputs) URL.revokeObjectURL(o.url);
      outputs = [];
      outLinks.innerHTML = '';
      outWrap.style.display = 'none';
      zipBtn.disabled = true;
      dlAllBtn.disabled = true;
      zipHint.style.display = 'none';

      const global = readGlobalSettings();

      statusEl.textContent = 'è™•ç†ä¸­â€¦';
      progEl.style.width = '0%';
      processBtn.disabled = true;

      const total = items.length;
      for (let i=0;i<total;i++){
        const it = items[i];
        const setting = mergeSettings(global, it.overrides);

        const { blob, name, mime } = await processOne(it, setting, i);
        const url = URL.createObjectURL(blob);
        outputs.push({ name, blob, url, mime });

        progEl.style.width = `${Math.round(((i+1)/total)*100)}%`;
        statusEl.textContent = `è™•ç†ä¸­â€¦ (${i+1}/${total})`;
        await sleep(10); // yield to UI
      }

      renderOutputs();
      outWrap.style.display = 'block';
      processBtn.disabled = false;
      statusEl.textContent = `å®Œæˆï¼šå·²ç”¢ç”Ÿ ${outputs.length} å¼µè¼¸å‡º`;

      // ZIP availability
      if (typeof JSZip === 'undefined') {
        zipBtn.disabled = true;
        zipHint.style.display = 'block';
        zipHint.textContent = 'âš ï¸ ZIP åŠŸèƒ½éœ€è¦ JSZipï¼ˆCDNï¼‰ã€‚ç›®å‰æœªè¼‰å…¥ï¼Œä»å¯é€å¼µä¸‹è¼‰ã€‚';
      } else {
        zipBtn.disabled = false;
      }
      dlAllBtn.disabled = false;
    });

    zipBtn.addEventListener('click', async () => {
      if (!outputs.length) return;
      if (typeof JSZip === 'undefined') {
        alert('ZIP åŠŸèƒ½æœªè¼‰å…¥ï¼ˆé›¢ç·šæˆ– CDN è¢«æ“‹ï¼‰ã€‚è«‹ç”¨é€å¼µä¸‹è¼‰ã€‚');
        return;
      }

      zipBtn.disabled = true;
      statusEl.textContent = 'æ‰“åŒ… ZIP ä¸­â€¦';

      const zip = new JSZip();
      for (const o of outputs) {
        zip.file(o.name, o.blob);
      }

      const zipBlob = await zip.generateAsync({ type:'blob', compression:'DEFLATE', compressionOptions:{level:6} });
      const zipUrl = URL.createObjectURL(zipBlob);

      // trigger download
      triggerDownload(zipUrl, `images_${Date.now()}.zip`);
      setTimeout(() => URL.revokeObjectURL(zipUrl), 60_000);

      statusEl.textContent = 'ZIP å·²è§¸ç™¼ä¸‹è¼‰';
      zipBtn.disabled = false;
    });

    dlAllBtn.addEventListener('click', async () => {
      if (!outputs.length) return;
      // sequentially trigger downloads
      for (const o of outputs) {
        triggerDownload(o.url, o.name);
        await sleep(350); // some browsers need delay
      }
      statusEl.textContent = 'å·²é€å¼µè§¸ç™¼ä¸‹è¼‰ï¼ˆè‹¥è¢«ç€è¦½å™¨é˜»æ“‹ï¼Œè«‹æ”¹ç”¨ ZIP æˆ–æ‰‹å‹•é»é€£çµï¼‰';
    });

    function defaultOverrides(){
      return {
        enableOverride:false,
        // per-photo overrides; null means inherit from global
        outFormat:null, quality:null,
        sizeMode:null, sizeValue:null, wValue:null, hValue:null,
        ratioMode:null, ratioW:null, ratioH:null,
        rot:null, flip:null,
        brightness:null, contrast:null, saturate:null, grayscale:null,
        sharpen:null, blur:null,
        namePrefix:null,
        padColor:'#000000' // for pad mode
      };
    }

    function readGlobalSettings(){
      return {
        outFormat: outFormat.value,
        quality: parseFloat(quality.value),
        sizeMode: sizeMode.value,
        sizeValue: parseInt(sizeValue.value,10),
        wValue: parseInt(wValue.value,10),
        hValue: parseInt(hValue.value,10),

        ratioMode: ratioMode.value,
        ratioW: parseInt(ratioW.value,10),
        ratioH: parseInt(ratioH.value,10),

        rot: parseInt(rot.value,10),
        flip: flip.value,

        brightness: parseFloat(brightness.value),
        contrast: parseFloat(contrast.value),
        saturate: parseFloat(saturate.value),
        grayscale: parseFloat(grayscale.value),
        sharpen: parseFloat(sharpen.value),
        blur: parseFloat(blur.value),

        namePrefix: namePrefix.value || 'processed_',
        padColor:'#000000'
      };
    }

    function mergeSettings(global, overrides){
      if (!overrides.enableOverride) return global;

      const pick = (k) => (overrides[k] === null || overrides[k] === undefined) ? global[k] : overrides[k];
      return {
        outFormat: pick('outFormat'),
        quality: pick('quality'),
        sizeMode: pick('sizeMode'),
        sizeValue: pick('sizeValue'),
        wValue: pick('wValue'),
        hValue: pick('hValue'),
        ratioMode: pick('ratioMode'),
        ratioW: pick('ratioW'),
        ratioH: pick('ratioH'),
        rot: pick('rot'),
        flip: pick('flip'),
        brightness: pick('brightness'),
        contrast: pick('contrast'),
        saturate: pick('saturate'),
        grayscale: pick('grayscale'),
        sharpen: pick('sharpen'),
        blur: pick('blur'),
        namePrefix: pick('namePrefix'),
        padColor: overrides.padColor || global.padColor
      };
    }

    async function processOne(item, setting, index){
      // Step A: compute output size
      let srcW = item.w, srcH = item.h;

      // rotation swaps dimensions for 90/270 in final
      const rotDeg = ((setting.rot % 360) + 360) % 360;
      const rotSwaps = (rotDeg === 90 || rotDeg === 270);

      // compute base target W/H before ratio operations
      let targetW = srcW, targetH = srcH;

      if (setting.sizeMode === 'keep') {
        targetW = srcW; targetH = srcH;
      } else if (setting.sizeMode === 'scale') {
        const s = Math.max(0.01, setting.sizeValue || 1);
        targetW = Math.round(srcW * s);
        targetH = Math.round(srcH * s);
      } else if (setting.sizeMode === 'wh') {
        targetW = Math.max(1, setting.wValue || srcW);
        targetH = Math.max(1, setting.hValue || srcH);
      } else { // longEdge
        const le = Math.max(1, setting.sizeValue || Math.max(srcW, srcH));
        const scale = le / Math.max(srcW, srcH);
        targetW = Math.round(srcW * scale);
        targetH = Math.round(srcH * scale);
      }

      // Step B: ratio handling influences how we draw image into target canvas
      const ratio = Math.max(1e-6, (setting.ratioW || 1) / (setting.ratioH || 1));

      // If ratioMode is keep, we use targetW/targetH as computed.
      // If crop/pad, we enforce the canvas ratio while keeping a logical size.
      let canvasW = targetW;
      let canvasH = targetH;

      if (setting.ratioMode === 'crop' || setting.ratioMode === 'pad') {
        // enforce ratio based on whichever is closer while maintaining approx area
        // We'll set canvas by fitting target size into that ratio.
        const cur = targetW / targetH;
        if (cur > ratio) {
          // too wide -> adjust width
          canvasW = Math.round(targetH * ratio);
          canvasH = targetH;
        } else {
          // too tall -> adjust height
          canvasW = targetW;
          canvasH = Math.round(targetW / ratio);
        }
        // Avoid 0
        canvasW = Math.max(1, canvasW);
        canvasH = Math.max(1, canvasH);
      }

      // For stretch: canvas is targetW/targetH; we will stretch draw
      if (setting.ratioMode === 'stretch') {
        canvasW = targetW; canvasH = targetH;
      }

      // apply rotation swap to canvas dimension after enforcing ratio
      const finalW = rotSwaps ? canvasH : canvasW;
      const finalH = rotSwaps ? canvasW : canvasH;

      // Create working canvas
      const canvas = document.createElement('canvas');
      canvas.width = finalW;
      canvas.height = finalH;
      const ctx = canvas.getContext('2d', { willReadFrequently: true });

      // background for pad mode (useful for PNG/JPG)
      if (setting.ratioMode === 'pad') {
        ctx.fillStyle = setting.padColor || '#000';
        ctx.fillRect(0,0,finalW,finalH);
      }

      // filters
      ctx.filter = [
        `brightness(${clamp(setting.brightness,0.1,3)})`,
        `contrast(${clamp(setting.contrast,0.1,3)})`,
        `saturate(${clamp(setting.saturate,0,5)})`,
        `grayscale(${clamp(setting.grayscale,0,1)})`,
        `blur(${clamp(setting.blur,0,20)}px)`
      ].join(' ');

      // transform for rotation/flip
      ctx.save();
      // Move origin to center
      ctx.translate(finalW/2, finalH/2);

      // rotation
      const rad = rotDeg * Math.PI / 180;
      ctx.rotate(rad);

      // flip
      let sx = 1, sy = 1;
      if (setting.flip === 'h') sx = -1;
      if (setting.flip === 'v') sy = -1;
      if (setting.flip === 'hv') { sx = -1; sy = -1; }
      ctx.scale(sx, sy);

      // Determine draw box size BEFORE rotation (in rotated coordinate space)
      const drawW = canvasW;
      const drawH = canvasH;

      // source rect for crop
      let sX=0, sY=0, sW=srcW, sH=srcH;

      if (setting.ratioMode === 'crop') {
        const srcRatio = srcW/srcH;
        if (srcRatio > ratio) {
          // source too wide -> crop width
          sH = srcH;
          sW = Math.round(srcH * ratio);
          sX = Math.round((srcW - sW)/2);
          sY = 0;
        } else {
          // source too tall -> crop height
          sW = srcW;
          sH = Math.round(srcW / ratio);
          sX = 0;
          sY = Math.round((srcH - sH)/2);
        }
      }

      // destination rect for pad/keep/crop is drawW/drawH centered
      let dW = drawW, dH = drawH;

      if (setting.ratioMode === 'pad' || setting.ratioMode === 'keep' || setting.ratioMode === 'crop') {
        // keep image aspect inside destination
        const wantedRatio = dW/dH;
        const srcR = sW/sH;
        if (srcR > wantedRatio) {
          // fit width
          dH = Math.round(dW / srcR);
        } else {
          // fit height
          dW = Math.round(dH * srcR);
        }
      }
      // stretch: use full drawW/drawH without preserving aspect
      if (setting.ratioMode === 'stretch') {
        dW = drawW; dH = drawH;
      }

      // draw at center (-dW/2, -dH/2) in rotated space
      ctx.drawImage(item.img, sX, sY, sW, sH, -dW/2, -dH/2, dW, dH);
      ctx.restore();

      // optional sharpen post-process
      const sharp = clamp(setting.sharpen, 0, 1);
      if (sharp > 0) {
        applySharpen(ctx, canvas.width, canvas.height, sharp);
      }

      // export
      const mime = setting.outFormat;
      const ext = mime === 'image/png' ? 'png' : (mime === 'image/webp' ? 'webp' : 'jpg');

      const base = stripExt(item.file.name);
      const prefix = (setting.namePrefix || 'processed_');
      const name = `${prefix}${String(index+1).padStart(3,'0')}_${base}.${ext}`;

      const blob = await canvasToBlob(canvas, mime, setting.quality);
      return { blob, name, mime };
    }

    function renderList(){
      imgList.innerHTML = '';
      for (const it of items) {
        const div = document.createElement('div');
        div.className = 'item';

        div.innerHTML = `
          <div class="itemHead">
            <img class="thumb" src="${it.url}" alt="thumb"/>
            <div style="min-width:0">
              <div class="title" title="${escapeHtml(it.file.name)}">${escapeHtml(it.file.name)}</div>
              <div class="meta">${it.w}Ã—${it.h} â€¢ ${(it.file.size/1024/1024).toFixed(2)} MB</div>
            </div>
          </div>

          <details>
            <summary>å–®å¼µè¦†å¯«ï¼ˆåªæ”¹é€™å¼µï¼‰</summary>
            <div class="miniRow" style="margin-top:10px">
              <div class="chip" style="justify-content:space-between;width:100%">
                <span>å•Ÿç”¨è¦†å¯«</span>
                <input type="checkbox" data-k="enableOverride" />
              </div>
            </div>

            <div class="miniRow">
              <div>
                <label>è¼¸å‡ºæ ¼å¼</label>
                <select data-k="outFormat">
                  <option value="">(æ²¿ç”¨å…¨åŸŸ)</option>
                  <option value="image/jpeg">JPG</option>
                  <option value="image/webp">WebP</option>
                  <option value="image/png">PNG</option>
                </select>
              </div>
              <div>
                <label>å“è³ª</label>
                <input data-k="quality" type="number" step="0.01" min="0.1" max="1" placeholder="(æ²¿ç”¨å…¨åŸŸ)" />
              </div>
            </div>

            <div class="miniRow">
              <div>
                <label>å°ºå¯¸æ¨¡å¼</label>
                <select data-k="sizeMode">
                  <option value="">(æ²¿ç”¨å…¨åŸŸ)</option>
                  <option value="longEdge">é•·é‚Š</option>
                  <option value="wh">å¯¬é«˜</option>
                  <option value="scale">å€ç‡</option>
                  <option value="keep">åŸå°ºå¯¸</option>
                </select>
              </div>
              <div>
                <label>é•·é‚Š/å€ç‡</label>
                <input data-k="sizeValue" type="number" placeholder="(æ²¿ç”¨å…¨åŸŸ)" />
              </div>
            </div>

            <div class="miniRow">
              <div>
                <label>å¯¬(px)</label>
                <input data-k="wValue" type="number" placeholder="(æ²¿ç”¨å…¨åŸŸ)" />
              </div>
              <div>
                <label>é«˜(px)</label>
                <input data-k="hValue" type="number" placeholder="(æ²¿ç”¨å…¨åŸŸ)" />
              </div>
            </div>

            <div class="miniRow">
              <div>
                <label>æ¯”ä¾‹è™•ç†</label>
                <select data-k="ratioMode">
                  <option value="">(æ²¿ç”¨å…¨åŸŸ)</option>
                  <option value="keep">ç¶­æŒ</option>
                  <option value="stretch">æ‹‰ä¼¸</option>
                  <option value="crop">è£åˆ‡</option>
                  <option value="pad">è£œé‚Š</option>
                </select>
              </div>
              <div class="miniRow" style="margin:0;gap:10px">
                <div>
                  <label>æ¯”ä¾‹å¯¬</label>
                  <input data-k="ratioW" type="number" placeholder="(æ²¿ç”¨å…¨åŸŸ)" />
                </div>
                <div>
                  <label>æ¯”ä¾‹é«˜</label>
                  <input data-k="ratioH" type="number" placeholder="(æ²¿ç”¨å…¨åŸŸ)" />
                </div>
              </div>
            </div>

            <div class="miniRow">
              <div>
                <label>æ—‹è½‰</label>
                <select data-k="rot">
                  <option value="">(æ²¿ç”¨å…¨åŸŸ)</option>
                  <option value="0">0Â°</option>
                  <option value="90">90Â°</option>
                  <option value="180">180Â°</option>
                  <option value="270">270Â°</option>
                </select>
              </div>
              <div>
                <label>é¡åƒ</label>
                <select data-k="flip">
                  <option value="">(æ²¿ç”¨å…¨åŸŸ)</option>
                  <option value="none">ä¸é¡åƒ</option>
                  <option value="h">æ°´å¹³</option>
                  <option value="v">å‚ç›´</option>
                  <option value="hv">æ°´å¹³+å‚ç›´</option>
                </select>
              </div>
            </div>

            <div class="miniRow">
              <div>
                <label>äº®åº¦ (0.5~1.5)</label>
                <input data-k="brightness" type="number" step="0.01" placeholder="(æ²¿ç”¨å…¨åŸŸ)" />
              </div>
              <div>
                <label>å°æ¯” (0.5~1.5)</label>
                <input data-k="contrast" type="number" step="0.01" placeholder="(æ²¿ç”¨å…¨åŸŸ)" />
              </div>
            </div>

            <div class="miniRow">
              <div>
                <label>é£½å’Œ (0~2)</label>
                <input data-k="saturate" type="number" step="0.01" placeholder="(æ²¿ç”¨å…¨åŸŸ)" />
              </div>
              <div>
                <label>ç°éš (0~1)</label>
                <input data-k="grayscale" type="number" step="0.01" placeholder="(æ²¿ç”¨å…¨åŸŸ)" />
              </div>
            </div>

            <div class="miniRow3">
              <div>
                <label>éŠ³åŒ– (0~1)</label>
                <input data-k="sharpen" type="number" step="0.05" placeholder="(æ²¿ç”¨å…¨åŸŸ)" />
              </div>
              <div>
                <label>æ¨¡ç³Š (0~6)</label>
                <input data-k="blur" type="number" step="0.1" placeholder="(æ²¿ç”¨å…¨åŸŸ)" />
              </div>
              <div>
                <label>æª”åå‰ç¶´</label>
                <input data-k="namePrefix" type="text" placeholder="(æ²¿ç”¨å…¨åŸŸ)" />
              </div>
            </div>

            <div class="hint">æç¤ºï¼šåªæœ‰å‹¾ã€Œå•Ÿç”¨è¦†å¯«ã€æ‰æœƒä½¿ç”¨é€™å¼µçš„è¨­å®šã€‚</div>
          </details>
        `;

        // bind events
        const controls = div.querySelectorAll('[data-k]');
        controls.forEach(c => {
          c.addEventListener('input', () => syncOverrides(it, div));
          c.addEventListener('change', () => syncOverrides(it, div));
        });

        imgList.appendChild(div);
      }
    }

    function syncOverrides(it, container){
      const get = (k) => container.querySelector(`[data-k="${k}"]`);
      const o = it.overrides;

      o.enableOverride = !!get('enableOverride').checked;

      const readVal = (k, parser=null) => {
        const node = get(k);
        if (!node) return null;
        if (node.type === 'checkbox') return !!node.checked;
        const v = node.value;
        if (v === '') return null;
        return parser ? parser(v) : v;
      };

      o.outFormat = readVal('outFormat');
      o.quality = readVal('quality', parseFloat);

      o.sizeMode = readVal('sizeMode');
      o.sizeValue = readVal('sizeValue', (x)=>parseInt(x,10));
      o.wValue = readVal('wValue', (x)=>parseInt(x,10));
      o.hValue = readVal('hValue', (x)=>parseInt(x,10));

      o.ratioMode = readVal('ratioMode');
      o.ratioW = readVal('ratioW', (x)=>parseInt(x,10));
      o.ratioH = readVal('ratioH', (x)=>parseInt(x,10));

      o.rot = readVal('rot', (x)=>parseInt(x,10));
      o.flip = readVal('flip');

      o.brightness = readVal('brightness', parseFloat);
      o.contrast = readVal('contrast', parseFloat);
      o.saturate = readVal('saturate', parseFloat);
      o.grayscale = readVal('grayscale', parseFloat);
      o.sharpen = readVal('sharpen', parseFloat);
      o.blur = readVal('blur', parseFloat);

      o.namePrefix = readVal('namePrefix');
    }

    function renderOutputs(){
      outLinks.innerHTML = '';
      for (const o of outputs) {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="itemHead">
            <div style="flex:1;min-width:0">
              <div class="title" title="${escapeHtml(o.name)}">${escapeHtml(o.name)}</div>
              <div class="meta">${o.mime} â€¢ ${(o.blob.size/1024).toFixed(0)} KB</div>
            </div>
            <a class="dl" href="${o.url}" download="${escapeHtml(o.name)}">ä¸‹è¼‰</a>
          </div>
        `;
        outLinks.appendChild(div);
      }
    }

    function loadImage(url){
      return new Promise((res, rej) => {
        const img = new Image();
        img.onload = () => res(img);
        img.onerror = rej;
        img.src = url;
      });
    }

    function stripExt(name){
      const i = name.lastIndexOf('.');
      return i>0 ? name.slice(0,i) : name;
    }

    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

    function clamp(v, a, b){
      v = Number(v);
      if (Number.isNaN(v)) v = a;
      return Math.min(b, Math.max(a, v));
    }

    function canvasToBlob(canvas, mime, q){
      return new Promise((res) => {
        if (mime === 'image/png') {
          canvas.toBlob((b)=>res(b), mime);
        } else {
          const qq = clamp(q, 0.1, 1);
          canvas.toBlob((b)=>res(b), mime, qq);
        }
      });
    }

    function triggerDownload(url, filename){
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // Simple unsharp mask-ish sharpen via convolution (3x3)
    function applySharpen(ctx, w, h, amount){
      const imgData = ctx.getImageData(0,0,w,h);
      const src = imgData.data;
      const out = new Uint8ClampedArray(src.length);

      // kernel = [0,-1,0,-1,5,-1,0,-1,0]
      const k = [0,-1,0,-1,5,-1,0,-1,0];
      const idx = (x,y,c)=>((y*w+x)*4+c);

      for (let y=0;y<h;y++){
        for (let x=0;x<w;x++){
          for (let c=0;c<3;c++){
            let sum = 0;
            let ki = 0;
            for (let ky=-1;ky<=1;ky++){
              for (let kx=-1;kx<=1;kx++){
                const xx = Math.min(w-1, Math.max(0, x+kx));
                const yy = Math.min(h-1, Math.max(0, y+ky));
                sum += src[idx(xx,yy,c)] * k[ki++];
              }
            }
            const orig = src[idx(x,y,c)];
            const sharp = sum;
            const mixed = orig*(1-amount) + sharp*amount;
            out[idx(x,y,c)] = clamp(mixed, 0, 255);
          }
          out[idx(x,y,3)] = src[idx(x,y,3)];
        }
      }
      imgData.data.set(out);
      ctx.putImageData(imgData,0,0);
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }
  </script>
</body>
</html>
