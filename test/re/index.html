<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登入您的帳戶</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts 的 Inter 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background-color: #f3f4f6;
            background-image: radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0px, transparent 50%),
                              radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0px, transparent 50%),
                              radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0px, transparent 50%);
        }
    </style>
</head>
<body class="gradient-bg flex items-center justify-center min-h-screen p-4">

    <!-- 主應用程式容器 (SPA 的 "舞台") -->
    <div id="app-container" class="w-full max-w-md">
        <!-- 登入或個人頁面內容將會被動態插入到此處 -->
    </div>

    <!-- ====================================================== -->
    <!-- JAVASCRIPT LOGIC STARTS HERE -->
    <!-- ====================================================== -->
    <script>
        // === HTML 模板區域 ===
        const loginTemplate = `
            <div class="bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl overflow-hidden">
                <div class="p-8 md:p-12">
                    <div id="messageBox" class="p-4 mb-4 text-sm rounded-lg hidden" role="alert"></div>
                    <div class="text-center mb-4">
                        <h1 class="text-3xl font-bold text-white tracking-tight">歡迎回來</h1>
                        <p class="text-gray-300 mt-2">請登入以繼續</p>
                    </div>
                    <form id="loginForm" class="space-y-6">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-200">電子郵件地址</label>
                            <div class="mt-1">
                                <input id="email" name="email" type="email" autocomplete="email" required
                                    class="w-full px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between">
                                <label for="password" class="block text-sm font-medium text-gray-200">密碼</label>
                            </div>
                            <div class="mt-1">
                                <input id="password" name="password" type="password" autocomplete="current-password" required
                                    class="w-full px-4 py-3 bg-gray-900/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <button type="submit" id="loginButton"
                                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-blue-500 transition-all duration-300 transform hover:scale-105">
                                登入
                            </button>
                        </div>
                    </form>
                    <div class="mt-8 text-center text-sm text-gray-400">
                        <p>
                            還沒有帳戶？
                            <a href="register.html" class="font-medium text-blue-400 hover:text-blue-300 transition-colors duration-300">
                                立即註冊
                            </a>
                        </p>
                    </div>
                </div>
            </div>
        `;

        const personalPageTemplate = (userData) => `
            <div class="bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl overflow-hidden">
                <div class="p-8 md:p-12 text-white">
                    <div id="messageBox" class="p-4 mb-4 text-sm rounded-lg hidden" role="alert"></div>
                    <div class="text-center">
                        <h1 class="text-3xl font-bold tracking-tight">個人頁面</h1>
                        <p class="text-gray-300 mt-2">歡迎回來, <span class="font-semibold text-blue-300">${userData.email || '使用者'}</span>!</p>
                    </div>
                    <div class="mt-8 border-t border-gray-600 pt-8">
                        <h2 class="text-xl font-semibold mb-4">帳戶資訊</h2>
                        <p class="text-gray-300">這裡是您的個人儀表板。</p>
                    </div>
                    <div class="mt-8">
                         <button id="logoutButton" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-red-500 transition-all duration-300">
                            登出
                        </button>
                    </div>
                </div>
            </div>
        `;

        // === 全域變數和設定 ===
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxMhWQNqO_n3sxQcwO_cLZWTd-dwYMKgi9vVrUhlAmzvHQWTQSZTY_qnRL3YwxSkdq3/exec';
        const appContainer = document.getElementById('app-container');

        // === 畫面渲染函數 ===
        function renderLoginView() {
            appContainer.innerHTML = loginTemplate;
            const loginForm = document.getElementById('loginForm');
            loginForm.addEventListener('submit', handleLogin);
        }

        function renderPersonalPageView(userData) {
            appContainer.innerHTML = personalPageTemplate(userData);
            const logoutButton = document.getElementById('logoutButton');
            logoutButton.addEventListener('click', handleLogout);
        }

        // === 事件處理函數 ===
        async function handleLogin(e) {
            e.preventDefault();
            displayMessage('', 'clear');
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');

            if (!email || !password) {
                displayMessage('請輸入電子郵件和密碼。', 'error');
                return;
            }
            
            setButtonLoading(loginButton, true, '登入中...');

            const requestBody = {
                action: 'login',
                payload: { email, password }
            };

            try {
                const response = await apiCall(requestBody);
                if(response.status === 'success') {
                    renderPersonalPageView(response.data || { email: email }); 
                } else {
                    // 如果後端回傳了定義好的錯誤訊息
                    displayMessage(response.message, response.status);
                    setButtonLoading(loginButton, false, '登入');
                }
            } catch (error) {
                // 如果是網路層級或 fetch 本身的錯誤
                displayMessage(error.message, 'error');
                console.error('Login Error:', error);
                setButtonLoading(loginButton, false, '登入');
            }
        }
        
        function handleLogout() {
            renderLoginView();
            setTimeout(() => {
                displayMessage('您已成功登出。', 'success');
            }, 100);
        }

        // === 輔助函數 (已更新) ===
        async function apiCall(body) {
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(body),
                    // mode: 'cors' 是預設值，不用特別寫
                    redirect: 'follow' 
                });

                // 檢查伺服器回應是否成功 (HTTP 狀態碼 200-299)
                if (!response.ok) {
                    // 如果伺服器回傳了錯誤狀態碼 (如 404, 500)，拋出錯誤
                    throw new Error(`伺服器錯誤: HTTP 狀態碼 ${response.status}`);
                }
                
                // 嘗試解析 JSON
                const textResponse = await response.text();
                try {
                    return JSON.parse(textResponse);
                } catch (e) {
                    console.error("無法解析伺服器回應為 JSON:", textResponse);
                    throw new Error("伺服器回應了非預期的格式，可能是 HTML 錯誤頁面。");
                }

            } catch (error) {
                // 捕捉網路錯誤 (例如 CORS 錯誤, DNS 問題) 或上面拋出的錯誤
                console.error("apiCall 函數發生錯誤:", error);
                // 將錯誤重新拋出，讓呼叫它的地方 (handleLogin) 可以捕捉到
                throw error;
            }
        }

        function setButtonLoading(button, isLoading, text) {
            if (!button) return;
            button.disabled = isLoading;
            button.textContent = text;
            isLoading ? button.classList.add('opacity-50', 'cursor-not-allowed')
                      : button.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        
        function displayMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            if (!messageBox) return;
            if (type === 'clear' || !message) {
                messageBox.classList.add('hidden');
                return;
            }
            messageBox.textContent = message;
            messageBox.className = 'p-4 mb-4 text-sm rounded-lg';
            switch(type) {
                case 'success': messageBox.classList.add('bg-green-100', 'text-green-800'); break;
                case 'error': messageBox.classList.add('bg-red-100', 'text-red-800'); break;
                default: messageBox.classList.add('bg-blue-100', 'text-blue-800'); break;
            }
        }
        
        // === 應用程式初始化 ===
        document.addEventListener('DOMContentLoaded', () => {
            renderLoginView();
        });
    </script>
</body>
</html>
